/**
 * Обогащённый контент для 8 гайдов пути новичка.
 * Используется скриптом enrich-tools.ts для обновления Payload CMS.
 *
 * Запуск: docker compose exec app npx tsx src/seed/enrich-tools.ts
 */

import {
  heading,
  paragraph,
  list,
  quote,
  codeBlock,
  hr,
  root,
} from "../lexical";

export interface EnrichedGuideContent {
  slug: string;
  content: ReturnType<typeof root>;
  seoTitle: string;
  seoDescription: string;
}

export const enrichedGuides: EnrichedGuideContent[] = [
  /* =====================================================
     1. Что такое вайбкодинг
     ===================================================== */
  {
    slug: "chto-takoe-vajbkoding",
    seoTitle: "Что такое вайбкодинг — создание приложений с Claude",
    seoDescription:
      "Вайбкодинг — создание приложений с AI без написания кода руками. Принцип Мозг+Руки, три модели Claude и честные ожидания от процесса.",
    content: root([
      heading(2, "Код без кода — как это вообще возможно"),
      paragraph(
        "Вайбкодинг — это когда ты создаёшь полноценные приложения, **не написав ни строчки кода руками**. Ты описываешь задачу на русском языке, а Claude пишет код за тебя. Звучит как маркетинг, но это работает — и сайт, который ты сейчас читаешь, создан именно так.",
      ),
      paragraph(
        "Важная оговорка: ты не заменяешь программиста — ты *становишься* программистом, у которого есть армия исполнителей. Твоя задача — думать, ставить задачи, проверять результат. Не печатать.",
      ),
      quote(
        "Вайбкодинг — это не «попросить ChatGPT написать код». Это система: правильные промпты + правильные инструменты + правильный процесс.",
      ),

      hr(),

      heading(2, "Принцип «Мозг + Руки»"),
      paragraph(
        "Ключевая идея Vibe Framework — разделение на **что делать** и **как делать**:",
      ),
      list([
        "**Мозг** (фреймворк) — живёт в `CLAUDE.md`, `rules/`, workflow-маркерах. Описывает ЧТО проверять, КОГДА запускать, КАКОЙ режим выбрать",
        "**Руки** (инструменты) — hooks, agents, plugins, skills, commands. Выполняют конкретную работу: сканируют, форматируют, ревьюят",
      ]),
      paragraph(
        "Без этого разделения — чистый промпт-инжиниринг: пишешь простыню текста и надеешься, что модель всё запомнит. Контекстное окно конечно, в длинных сессиях модель «забывает» правила, гарантий нет.",
      ),
      paragraph(
        "Мозг + Руки решают это: правила компактны и ссылаются на конкретные инструменты, хуки работают автоматически, агенты подключаются по требованию.",
      ),

      heading(3, "Пример: разговор с Claude"),
      paragraph("Так выглядит реальный рабочий промпт:"),
      codeBlock(
        `Ты: Добавь эндпоинт POST /api/users для регистрации.
     Принимает: { email, password, displayName }
     Проверяет: email уникальный, пароль >= 8 символов
     Возвращает: { id, email, displayName, token }
     Используй существующий UserService из src/services/user.ts

Claude: [читает файл, находит UserService, пишет эндпоинт, тесты, обновляет типы]`,
        "text",
      ),
      paragraph(
        "Заметь: промпт конкретный — стек, файлы, формат данных. Без этого Claude начнёт угадывать и ошибаться.",
      ),

      hr(),

      heading(2, "Три уровня моделей"),
      paragraph(
        "Claude выпускается в трёх вариантах с разной ценой и мощностью. Не все задачи требуют топ-модели:",
      ),
      list([
        "**Opus** — архитектура, планирование сложных систем, ревью критичного кода. Самая умная (~5x дороже Sonnet). Используй для задач, где ошибка дорого стоит",
        "**Sonnet** — рутинная реализация, тесты, субагенты. Оптимальное соотношение цена/качество. Рабочая лошадка для большинства задач",
        "**Haiku** — простые правки, форматирование, быстрые проверки (~10x дешевле Sonnet). Для задач, где скорость важнее глубины",
      ]),
      paragraph("На практике применяй правило:"),
      codeBlock(
        `Архитектура и планирование → Opus  (--model claude-opus-4-5)
Реализация и тесты          → Sonnet (дефолт)
Форматирование и правки     → Haiku  (--model claude-haiku-4-5)`,
        "text",
      ),
      quote(
        "Opus думает, Sonnet пишет, Haiku проверяет. Держи это в голове — сэкономишь деньги.",
      ),

      hr(),

      heading(2, "Чего ожидать — честно"),
      paragraph(
        "Вайбкодинг не равно «скажи AI и получи готовый продукт». Реальность такова:",
      ),
      list([
        "**Первая версия будет кривой** — это нормально. AI пишет рабочий, но не идеальный код. Итерируй",
        "**AI галлюцинирует** — ссылается на несуществующие функции, устаревшие API. Для этого есть Anti-Mirage проверки",
        "**Чем точнее промпт, тем лучше результат** — конкретика решает. Расплывчатый запрос = расплывчатый результат",
        "**Базовые концепции придётся понять** — файлы, терминал, git, Docker, `.env`. Не rocket science, но без этого не обойтись",
      ]),

      heading(3, "Сравнение подходов"),
      codeBlock(
        `Классическое программирование:
  Ты пишешь каждую строку кода
  Нужны: годы практики, знание синтаксиса, алгоритмов
  Результат: полный контроль, но медленно

No-code (Webflow, Bubble):
  Drag-and-drop интерфейс, без кода
  Нужны: понимание UI/UX, ограничен платформой
  Результат: быстро, но упираешься в ограничения

Вайбкодинг (Claude Code):
  Описываешь задачи на русском языке
  Нужны: базовые концепции, правильный процесс
  Результат: любые проекты, полная гибкость, быстро`,
        "text",
      ),
      paragraph(
        "Каждую из базовых концепций можно освоить за вечер. Дальше в этом пути — пошаговые инструкции.",
      ),
    ]),
  },

  /* =====================================================
     2. Четыре уровня работы
     ===================================================== */
  {
    slug: "chetyre-urovnya-raboty",
    seoTitle: "Четыре уровня работы вайбкодера — от фикса до проекта",
    seoDescription:
      "Фикс (5 мин), Фича (15–60 мин), Эпик (часы), Проект (дни) — как выбрать масштаб задачи и какой процесс запустить в Claude Code.",
    content: root([
      heading(2, "Зачем нужны уровни"),
      paragraph(
        "Не каждая задача требует полной спецификации, команды агентов и тонн планирования. Баг в одном файле и новый продукт с нуля — это разные вселенные. Уровень задачи определяет **глубину процесса**: какие инструменты включить, сколько проверок провести, нужны ли агенты.",
      ),
      paragraph(
        "Переусложнить простую задачу (Фикс через Проект) — потеря времени. Недооценить сложную (Проект через Фикс) — потеря нервов при переделке. Научись выбирать уровень правильно.",
      ),

      hr(),

      heading(2, "Уровень 1: Фикс — быстрое исправление"),
      heading(3, "Когда использовать"),
      list([
        "Баг в одном или двух файлах",
        "Опечатка, неправильный текст, цвет",
        "Сломавшийся импорт или конфиг",
        "Мелкая правка поведения",
      ]),
      heading(3, "Время и команда"),
      paragraph("**5–15 минут.** Команда: `/bug-fix`. Агентов: 0–1."),
      heading(3, "Процесс"),
      list(
        [
          "Определи проблему — скопируй полный стектрейс",
          "Исправь — Claude находит и правит файл",
          "Проверь — убедись, что не сломал остальное",
        ],
        true,
      ),
      paragraph(
        "Главное правило Фикса: **копируй стектрейс целиком**, не пересказывай своими словами. В ошибке есть строка файла, тип исключения, контекст — это именно то, что нужно Claude.",
      ),
      codeBlock(
        `# Хорошо — полный стектрейс
claude "Получаю ошибку:
TypeError: Cannot read properties of undefined (reading 'map')
    at FeedCard (src/components/FeedCard.tsx:47:23)
    at renderWithHooks (node_modules/react-dom/...)
Исправь"

# Плохо — пересказ
claude "Компонент FeedCard падает"`,
        "bash",
      ),

      hr(),

      heading(2, "Уровень 2: Фича — одна возможность"),
      heading(3, "Когда использовать"),
      list([
        "Новый эндпоинт или страница",
        "Новый компонент UI",
        "Изменение поведения существующей функции",
        "Добавление поля в форму и обработка на бэкенде",
      ]),
      heading(3, "Время и команда"),
      paragraph("**15–60 минут.** Команда: `/ship`. Агентов: 1–3."),
      heading(3, "Процесс"),
      list(
        [
          "Brainstorm — Claude задаёт уточняющие вопросы",
          "Plan — получи план с блоками до начала кодинга",
          "Approve — просмотри план, одобри или скорректируй",
          "Build — реализация блоками с чекпоинтами",
          "Test — авто-тесты и ревью",
          "Commit — один коммит с описанием",
        ],
        true,
      ),
      quote(
        "Всегда проси Claude показать план ПЕРЕД реализацией. Это в 10 раз дешевле, чем переделывать готовый код.",
      ),
      paragraph(
        "Фича — **основная единица работы** вайбкодера. Большинство задач умещается сюда.",
      ),

      hr(),

      heading(2, "Уровень 3: Эпик — крупная функциональность"),
      heading(3, "Когда использовать"),
      list([
        "Система авторизации (регистрация + логин + восстановление пароля + профиль)",
        "Переделка платёжной системы",
        "Новый раздел сайта с несколькими страницами",
        "Рефакторинг крупного модуля",
      ]),
      heading(3, "Время и команда"),
      paragraph("**1–4 часа.** PM + Agent Teams с wave-параллелизмом."),
      heading(3, "Пример декомпозиции Эпика"),
      codeBlock(
        `Эпик: Система авторизации

Wave 1 (параллельно, ~15 мин):
  task-001: Модель User + миграция PostgreSQL
  task-002: JWT хелпер + refresh tokens

Wave 2 (параллельно, ~20 мин):
  task-003: POST /api/auth/register
  task-004: POST /api/auth/login
  task-005: POST /api/auth/refresh

Wave 3 (последовательно, ~15 мин):
  task-006: Middleware авторизации
  task-007: GET /api/profile (защищённый)

Wave 4 (параллельно, ~20 мин):
  task-008: Интеграционные тесты полного флоу
  task-009: Документация + обновление CLAUDE.md`,
        "text",
      ),

      hr(),

      heading(2, "Уровень 4: Проект — создание с нуля"),
      heading(3, "Когда использовать"),
      list([
        "Новый продукт или MVP",
        "Полная переработка существующего сервиса",
        "Сложная система с несколькими модулями",
      ]),
      heading(3, "Время"),
      paragraph(
        "**Дни–недели.** Команда: `/new-project`. Все агенты задействованы.",
      ),
      heading(3, "7 фаз Проекта"),
      list(
        [
          "Фаза 0: Инфраструктура (VPS, Docker, Nginx, SSL)",
          "Фаза 1: User Spec — глубинное интервью (7 циклов)",
          "Фаза 2: Tech Spec — архитектура, стек, модель данных",
          "Фаза 3: Декомпозиция — атомарные задачи + волны",
          "Фаза 4: Реализация — TDD-цикл + Agent Teams",
          "Фаза 5: Тестирование — до 14 типов тестов",
          "Фаза 6: Финализация — QA + деплой + документация",
        ],
        true,
      ),

      hr(),

      heading(2, "Быстрая шпаргалка"),
      codeBlock(
        `Баг в одном-двух файлах?          → Фикс    (5–15 мин)
Одна новая функция или страница?   → Фича    (15–60 мин)
Несколько связанных функций?       → Эпик    (1–4 часа)
Новый продукт с нуля?              → Проект  (дни)

Правило неопределённости:
  Не уверен → начни с Фичи
  Вырастает за час → повысь до Эпика`,
        "text",
      ),
      paragraph("Лучше повысить уровень, чем недооценить и переделывать."),
    ]),
  },

  /* =====================================================
     3. Установка и настройка Claude Code
     ===================================================== */
  {
    slug: "ustanovka-i-nastrojka-claude-code",
    seoTitle: "Установка Claude Code CLI — пошаговая инструкция",
    seoDescription:
      "Установка Claude Code: Node.js 20, npm install, первый запуск, CLAUDE.md, глобальные настройки. Готово за 10 минут на macOS и Linux.",
    content: root([
      heading(2, "Что понадобится"),
      list([
        "**macOS, Linux или WSL2** — Windows только через WSL, нативно не поддерживается",
        "**Node.js 20 LTS** — более старые версии могут не работать",
        "**Аккаунт Anthropic** — console.anthropic.com, нужна кредитная карта для API",
        "**Терминал** — iTerm2, Terminal.app, Windows Terminal — любой",
      ]),

      hr(),

      heading(2, "Шаг 1: Установка Node.js"),
      paragraph(
        "Рекомендуется установить через `nvm` — это позволяет иметь несколько версий:",
      ),
      codeBlock(
        `# Установка nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash

# Перезапусти терминал, затем:
nvm install 20
nvm use 20
nvm alias default 20

# Проверка
node --version   # должно быть v20.x.x
npm --version    # должно быть 10.x.x`,
        "bash",
      ),
      paragraph(
        "Если `nvm` не подходит — скачай Node.js 20 LTS напрямую с nodejs.org. Главное — версия 18 или выше.",
      ),

      hr(),

      heading(2, "Шаг 2: Установка Claude Code"),
      codeBlock(
        `npm install -g @anthropic-ai/claude-code

# Проверка установки
claude --version`,
        "bash",
      ),
      paragraph(
        "Если команда `claude` не найдена после установки — проверь PATH для глобальных npm-пакетов:",
      ),
      codeBlock(
        `# Найти директорию глобальных пакетов npm
npm root -g

# Добавить в PATH (вставь в ~/.zshrc или ~/.bashrc)
export PATH="$(npm root -g)/../bin:$PATH"

# Применить без перезапуска терминала
source ~/.zshrc`,
        "bash",
      ),

      hr(),

      heading(2, "Шаг 3: Авторизация"),
      paragraph("Создай директорию проекта и запусти Claude Code:"),
      codeBlock(
        `mkdir my-first-project
cd my-first-project
claude`,
        "bash",
      ),
      paragraph(
        "При первом запуске Claude Code предложит авторизоваться. Нажми Enter — откроется браузер с Anthropic Console. Войди или зарегистрируйся, подтверди доступ.",
      ),
      paragraph("Если авторизация слетела или нужно переключить аккаунт:"),
      codeBlock("claude auth login", "bash"),

      hr(),

      heading(2, "Шаг 4: Создание CLAUDE.md"),
      paragraph(
        "`CLAUDE.md` — главный конфиг проекта. Claude читает его при каждом запуске. Это твой «брифинг» для AI: что за проект, какой стек, какие правила.",
      ),
      paragraph("Создай в корне проекта (`/CLAUDE.md`):"),
      codeBlock(
        `# Мой первый проект

Бот для учёта личных расходов. Telegram + PostgreSQL.

## Стек
- Python 3.12 + aiogram v3
- PostgreSQL 16
- Docker Compose
- Деплой на VPS (Ubuntu 22.04)

## Ключевые правила
- Код, комментарии, переменные — на русском
- Conventional commits: feat/fix/refactor/docs
- Тесты обязательны для бизнес-логики
- НИКОГДА не коммитить .env
- SQL только через параметризованные запросы

## Структура
src/
├── handlers/   # aiogram хендлеры
├── services/   # бизнес-логика
├── database/   # модели и миграции
└── utils/      # утилиты`,
        "markdown",
      ),
      quote(
        "Чем подробнее CLAUDE.md — тем меньше объяснений в промптах. Заполни один раз, пользуйся всегда.",
      ),

      hr(),

      heading(2, "Шаг 5: Глобальные настройки"),
      paragraph(
        "Для правил, общих для всех проектов, создай `~/.claude/CLAUDE.md`. Claude читает его в дополнение к проектному файлу:",
      ),
      codeBlock(
        `mkdir -p ~/.claude

cat > ~/.claude/CLAUDE.md << 'EOF'
# Глобальные правила

Разработчик: Иван, GMT+7, macOS.

## Язык
- Код, комментарии, переменные — русский
- Общение — русский, технический жаргон допустим

## Безопасность
- НИКОГДА не коммитить .env, токены, пароли
- SQL только через параметризацию
- Rate limiting на публичных endpoints

## Git
- Conventional commits: feat/fix/refactor/docs/test
- Коммитить только по явной команде
EOF`,
        "bash",
      ),

      hr(),

      heading(2, "Проверка и типичные проблемы"),
      codeBlock(
        `# Проверь версии
node --version    # v20.x.x
claude --version  # 1.x.x

# Первый запрос
cd my-first-project
claude "Привет! Какие файлы ты видишь в этом проекте?"`,
        "bash",
      ),
      list([
        "**`command not found: claude`** — глобальные пакеты npm не в PATH. Попробуй `npx claude` или добавь путь в `.zshrc`",
        "**`Authentication failed`** — перелогинься: `claude auth login`",
        "**CLAUDE.md не читается** — файл должен быть в директории, откуда запускается `claude`",
        "**Медленная работа** — переключись на Sonnet для рутинных задач: в 5 раз быстрее Opus",
        "**Ошибка прав при `npm install -g`** — используй nvm, тогда sudo не нужен",
      ]),
    ]),
  },

  /* =====================================================
     4. Настройка фреймворка: правила и хуки
     ===================================================== */
  {
    slug: "nastrojka-frejmvorka-pravila-i-huki",
    seoTitle: "Настройка фреймворка Claude Code — хуки, правила, плагины",
    seoDescription:
      "Три слоя настройки Claude Code: CLAUDE.md, rules/, hooks в settings.json, MCP-плагины. Минимальная конфигурация и примеры реальных хуков.",
    content: root([
      heading(2, "Три слоя настройки"),
      paragraph(
        "Claude Code настраивается на трёх уровнях — от общего к конкретному:",
      ),
      list([
        "**Глобальный** (`~/.claude/`) — правила для всех проектов: стиль, безопасность, git-конвенции",
        "**Проектный** (`.claude/` в корне) — настройки конкретного проекта: хуки, права, специфика стека",
        "**Сессионный** — настройки текущей сессии через промпт или slash-команды, не сохраняются",
      ]),
      paragraph(
        "Проектный слой переопределяет глобальный. Сессионный — временный.",
      ),

      hr(),

      heading(2, "Хуки — автоматические скрипты"),
      paragraph(
        "Хуки — это скрипты, которые запускаются **автоматически** на события Claude Code. Ты их не вызываешь — они работают сами. Настраиваются в `.claude/settings.json`:",
      ),
      codeBlock(
        `{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit",
        "command": "prettier --write \${FILEPATH} 2>/dev/null || true"
      },
      {
        "matcher": "Write|Edit",
        "command": "bash .claude/hooks/security-scan.sh \${FILEPATH}"
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "command": "bash .claude/hooks/destructive-guard.sh"
      }
    ],
    "Stop": [
      {
        "command": "bash .claude/hooks/check-debug-code.sh"
      }
    ]
  }
}`,
        "json",
      ),

      heading(3, "Четыре типа триггеров"),
      list([
        "**PreToolUse** — до выполнения инструмента. Блокировка деструктивных команд, бэкап перед изменением",
        "**PostToolUse** — после выполнения. Автоформатирование, security-scan, логирование",
        "**Stop** — при завершении сессии. Проверка на `console.log`/`debugger`, отчёты",
        "**Notification** — при событиях: compaction (сжатие контекста). Восстановление состояния",
      ]),

      heading(3, "Пример: хук защиты от деструктивных команд"),
      codeBlock(
        `#!/bin/bash
# .claude/hooks/destructive-guard.sh
# Блокирует rm -rf, DROP TABLE и подобное

COMMAND="$1"

PATTERNS=("rm -rf /" "rm -rf ~" "DROP TABLE" "truncate" "force-push")

for pattern in "\${PATTERNS[@]}"; do
  if echo "$COMMAND" | grep -qi "$pattern"; then
    echo "BLOCKED: Деструктивная команда: $pattern"
    exit 1
  fi
done
exit 0`,
        "bash",
      ),

      heading(3, "Пример: хук проверки debug-кода"),
      codeBlock(
        `#!/bin/bash
# .claude/hooks/check-debug-code.sh
# Запускается при Stop — ищет console.log, debugger

FOUND=$(git diff --cached --name-only | \
  xargs grep -l "console\\.log\\|debugger\\|print(" 2>/dev/null)

if [ -n "$FOUND" ]; then
  echo "WARN: Debug-код найден в:"
  echo "$FOUND"
  echo "Убери перед коммитом!"
fi`,
        "bash",
      ),

      hr(),

      heading(2, "Правила — директория rules/"),
      paragraph(
        "Правила живут в `rules/*.md`. Claude читает их как часть системного промпта. Каждый файл — отдельная область:",
      ),
      list([
        "**anti-mirage.md** — проверка реальности: все файлы и функции, на которые ссылается AI, реально существуют",
        "**coding-standards.md** — стандарты: DRY, KISS, размеры файлов и функций, именование",
        "**security.md** — безопасность: запрещённые паттерны, валидация, параметризация SQL",
        "**database.md** — работа с БД: миграции, именование, индексы, мягкое удаление",
        "**testing.md** — пирамида тестов, решение когда что писать, антипаттерны",
      ]),
      paragraph(
        "Начни с `anti-mirage.md` — это самый ценный файл. Спасёт часы отладки.",
      ),

      hr(),

      heading(2, "Плагины — MCP-серверы"),
      paragraph(
        "MCP (Model Context Protocol) — стандарт для расширений Claude. Плагины дают доступ к документации, базам данных, внешним API. Подключаются в `~/.claude/settings.json`:",
      ),
      codeBlock(
        `{
  "mcpServers": {
    "context7": {
      "command": "npx",
      "args": ["-y", "@context7/mcp-server"]
    },
    "mgrep": {
      "command": "npx",
      "args": ["-y", "@mgrep/mcp"]
    }
  }
}`,
        "json",
      ),
      list([
        "**context7** — актуальная документация библиотек. Вместо устаревших данных из обучения — живые доки",
        "**mgrep** — семантический поиск по кодовой базе. Быстрее `grep`, понимает смысл запроса",
        "**typescript-lsp** / **pyright-lsp** — типы и ошибки в реальном времени прямо в диалоге",
      ]),
      quote(
        "context7 — обязательный плагин. Claude часто галлюцинирует устаревшие API. context7 даёт реальную документацию.",
      ),

      hr(),

      heading(2, "Минимальная конфигурация на старте"),
      paragraph("Для нового проекта достаточно этой структуры:"),
      codeBlock(
        `my-project/
├── CLAUDE.md                    # Проектный конфиг
├── .claude/
│   ├── settings.json            # Хуки и права
│   └── hooks/
│       ├── security-scan.sh
│       └── check-debug-code.sh
└── rules/
    ├── anti-mirage.md           # Обязательно
    └── coding-standards.md     # Рекомендуется`,
        "text",
      ),
      paragraph(
        "Добавляй инструменты по мере необходимости. **5 рабочих хуков лучше, чем 50 настроенных криво.**",
      ),
    ]),
  },

  /* =====================================================
     5. Первый проект от нуля до деплоя
     ===================================================== */
  {
    slug: "pervyj-proekt-ot-nulya-do-deploya",
    seoTitle: "Первый проект на Claude Code — от нуля до деплоя",
    seoDescription:
      "Полный цикл создания проекта: 7 фаз от VPS до деплоя. Команда /new-project, User Spec, Tech Spec, TDD, Docker и CI/CD.",
    content: root([
      heading(2, "Обзор: 7 фаз создания проекта"),
      paragraph(
        "Весь процесс запускается командой `/new-project`. Claude сам определяет готовность каждой фазы, показывает результат и переходит дальше. Твои точки входа — одобрить план и ответить на вопросы бизнес-аналитика.",
      ),
      list(
        [
          "**Фаза 0** — Инфраструктура (VPS, Docker, Nginx, SSL)",
          "**Фаза 1** — User Spec: кто пользователь, что хочет, зачем",
          "**Фаза 2** — Tech Spec: стек, архитектура, модель данных",
          "**Фаза 3** — Декомпозиция: атомарные задачи + волны",
          "**Фаза 4** — Реализация: TDD-цикл + чекпоинты",
          "**Фаза 5** — Тестирование: до 14 типов тестов",
          "**Фаза 6** — Финализация: QA + деплой + документация",
        ],
        true,
      ),

      heading(3, "Ожидаемые временные рамки"),
      codeBlock(
        `Фаза 0: Инфраструктура    ~30 мин (один раз, потом переиспользуется)
Фаза 1: User Spec         ~1 час  (зависит от сложности проекта)
Фаза 2: Tech Spec         ~30 мин
Фаза 3: Декомпозиция      ~20 мин
Фаза 4: Реализация        дни/недели (основной объём работы)
Фаза 5: Тестирование      ~20% от времени реализации
Фаза 6: Финализация       ~1-2 часа`,
        "text",
      ),

      hr(),

      heading(2, "Фаза 0: Инфраструктура"),
      paragraph(
        "Поднять VPS, настроить безопасность, Docker, Nginx + SSL. Можно пропустить, если сервер уже настроен.",
      ),
      codeBlock(
        `# Базовая защита нового VPS (Ubuntu 22.04)
apt update && apt upgrade -y

# Файрвол
ufw default deny incoming
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable

# Docker
curl -fsSL https://get.docker.com | sh
usermod -aG docker $USER

# Docker Compose (plugin)
apt install docker-compose-plugin -y

# Проверка
docker --version
docker compose version`,
        "bash",
      ),

      hr(),

      heading(2, "Фазы 1–2: Спецификации"),
      paragraph(
        "Субагент **business-analyst** проводит глубинное интервью: 7 циклов вопросов от общего понимания до edge-cases. Он не просто спрашивает — предлагает варианты ответов, форматирует требования.",
      ),
      paragraph("Примерные вопросы бизнес-аналитика:"),
      list([
        "Кто будет пользоваться сервисом? Опиши одного конкретного пользователя",
        "Что самое важное должен уметь делать этот пользователь?",
        "Как выглядит успешное использование через 3 месяца?",
        "Что не входит в первую версию?",
        "Какие у тебя ограничения: бюджет, время, технические?",
      ]),
      paragraph(
        "Результат — `user-spec.md`. Затем **system-analyst** формирует `tech-spec.md` с архитектурой, стеком, моделью данных, всеми API-эндпоинтами.",
      ),
      quote(
        "Не торопи бизнес-аналитика. Чем подробнее user-spec — тем меньше переделок в реализации.",
      ),

      hr(),

      heading(2, "Фаза 3: Декомпозиция"),
      paragraph(
        "Tech-spec разбивается на атомарные задачи. Каждая задача содержит:",
      ),
      list([
        "Описание — что конкретно нужно сделать",
        "Пошаговый план — 5–10 шагов реализации",
        "TDD-якорь — названия тестов до написания кода",
        "Файлы для изменения — контекст без лишнего",
        "Acceptance criteria — как проверить, что готово",
      ]),
      codeBlock(
        `## Task-003: POST /api/auth/register

Создать эндпоинт регистрации пользователя.

### Шаги:
1. Добавить роут в src/api/auth.ts
2. Валидация { email, password, displayName }
3. Проверить уникальность email через UserService
4. Хэшировать пароль (bcrypt, rounds=12)
5. Создать запись User в БД
6. Вернуть { id, email, displayName, token }

### TDD-якорь:
- test_register_creates_user_200
- test_register_duplicate_email_409
- test_register_invalid_email_400
- test_register_weak_password_400

### Файлы:
- src/api/auth.ts (изменить)
- src/services/user.ts (изменить)
- tests/api/auth.test.ts (создать)`,
        "markdown",
      ),

      hr(),

      heading(2, "Фаза 4: Реализация"),
      paragraph(
        "Два режима: **последовательный** (один агент) или **командный** (Agent Teams, задачи параллельно волнами). Для маленьких проектов — последовательный. Для сложных — Agent Teams.",
      ),
      paragraph("TDD-цикл для каждой задачи:"),
      list(
        [
          "Напиши тесты (они красные — реализации нет)",
          "Напиши минимальный код (тесты становятся зелёными)",
          "Рефакторинг (тесты всё ещё зелёные)",
          "Ревью + коммит",
        ],
        true,
      ),

      hr(),

      heading(2, "Фаза 6: Деплой"),
      paragraph("Типичный `docker-compose.yml` для продакшена:"),
      codeBlock(
        `version: '3.9'

services:
  app:
    image: my-app:latest
    restart: unless-stopped
    env_file: .env
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: \${DB_USER}
      POSTGRES_PASSWORD: \${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "\${DB_USER}"]
      interval: 10s
      retries: 5

volumes:
  pgdata:`,
        "yaml",
      ),

      heading(2, "Советы для первого раза"),
      list([
        "**Начни с малого** — Telegram-бот, простое API, лендинг. Не Netflix",
        "**Коммить после каждого рабочего блока** — это страховка. Сломалось — откати к рабочему коммиту",
        "**Не оптимизируй раньше времени** — сначала пусть работает",
        "**Читай логи** — Docker logs, Nginx logs, application logs. Там все ответы",
      ]),
    ]),
  },

  /* =====================================================
     6. Работа с агентами и командами
     ===================================================== */
  {
    slug: "rabota-s-agentami-i-komandami",
    seoTitle: "Агенты и команды Claude Code — субагенты и параллелизм",
    seoDescription:
      "Каталог субагентов Claude Code: бизнес-аналитик, code-reviewer, security-auditor. Agent Teams, wave-параллелизм и конфигурация команды.",
    content: root([
      heading(2, "Зачем нужны субагенты"),
      paragraph(
        "Один AI-агент — бутылочное горлышко: он последовательный, у него один контекст, он может писать код или проверять безопасность — но не всё одновременно. Субагенты решают это: каждый специализируется, работают параллельно, каждый со своим контекстом.",
      ),
      quote(
        "Teammates на Sonnet стоят ~5x дешевле, чем если бы всё делал Opus. Lead координирует, рутину делегирует. Умно, а не дорого.",
      ),

      hr(),

      heading(2, "Каталог субагентов"),

      heading(3, "Фазовые — специальные роли для Проекта"),
      list([
        "**business-analyst** — глубинное интервью в 7 циклов: от «что хочет пользователь» до edge-cases. Предлагает варианты ответов",
        "**system-analyst** — технические вопросы: стек, модель данных, API-контракты",
        "**pm** — менеджер продукта в эпиках: читает tech-spec, строит execution plan, координирует",
      ]),

      heading(3, "Валидаторы — проверяют корректность"),
      list([
        "**skeptic** — детектор «миражей»: несуществующих файлов, функций, пакетов",
        "**completeness-validator** — трассировка user-spec → tech-spec в обе стороны",
        "**task-validator** — атомарность задач, шаблон, согласованность зависимостей",
        "**reality-checker** — существование файлов на диске, реализуемость",
        "**security-reviewer** — OWASP Top 10 в спецификации, до написания кода",
      ]),

      heading(3, "Код-ревьюеры — проверяют качество"),
      list([
        "**code-reviewer** — 10-мерный анализ: корректность, безопасность, производительность, DRY, SOLID",
        "**security-auditor** — хардкод секретов, SQL инъекции, XSS, открытые эндпоинты",
        "**test-reviewer** — покрытие, edge-cases, антипаттерны в тестах",
        "**architect** — оверинжиниринг, архитектурные решения, масштабируемость",
      ]),

      heading(3, "Исполнители — делают конкретную работу"),
      list([
        "**task-creator** — генерирует файлы задач из tech-spec по шаблону",
        "**tdd-guide** — ведёт TDD-цикл: тесты → код → рефакторинг",
        "**build-error-resolver** — диагностика и исправление ошибок сборки",
        "**doc-writer** — обновляет документацию после реализации фичи",
      ]),

      hr(),

      heading(2, "Agent Teams: параллельная работа"),
      paragraph(
        "Для эпиков используй Agent Teams. Lead (Opus) координирует, Teammates (Sonnet) выполняют задачи параллельно.",
      ),
      codeBlock(
        `# Конфигурация Agent Team

Team Lead (claude-opus-4-5):
  - Читает tech-spec и user-spec
  - Строит execution plan с волнами
  - Распределяет задачи между teammates
  - Собирает результаты, запускает интеграционные проверки
  - Принимает решение о переходе к следующей волне

Teammates (claude-sonnet-4-5, параллельно):
  - Каждый получает свой контекст: задачу + нужные файлы
  - Пишут код, тесты, документацию
  - Сообщают о блокерах Lead-у
  - Не видят работу других teammates`,
        "text",
      ),

      hr(),

      heading(2, "Wave-параллелизм"),
      paragraph(
        "Задачи группируются в волны по зависимостям. Внутри одной волны — независимые задачи, запускаются параллельно. Следующая волна ждёт завершения предыдущей.",
      ),
      codeBlock(
        `Wave 1: Фундамент (параллельно, ~15 мин)
  task-001: Модель User + миграция
  task-002: Конфиг БД + Docker Compose
  ↓ Ждём завершения...

Wave 2: Бизнес-логика (параллельно, ~20 мин)
  task-003: UserService.create(), .findByEmail()
  task-004: JWT хелпер + refresh tokens
  ↓ Ждём завершения...

Wave 3: API (параллельно, ~25 мин)
  task-005: POST /api/auth/register
  task-006: POST /api/auth/login
  task-007: POST /api/auth/refresh
  ↓ Ждём завершения...

Wave 4: Интеграция (последовательно, ~20 мин)
  task-008: Middleware авторизации
  task-009: Интеграционные тесты`,
        "text",
      ),

      heading(3, "Как определить зависимость задач"),
      list([
        "task-005 импортирует из task-003 → разные волны (task-005 после task-003)",
        "task-005 и task-006 не пересекаются по файлам → одна волна (параллельно)",
        "task-008 использует результаты всех API → последняя волна",
      ]),

      hr(),

      heading(2, "Как вызывать агентов"),
      codeBlock(
        `# Явный вызов code-reviewer
claude "Запусти code-reviewer для src/api/auth.ts"

# Security-аудит
claude "Проведи security-аудит auth flow"

# Agent Team для эпика
claude "/ship epic:auth-system"

# Автоматический вызов через Quality Gates:
# - После >20 строк нового кода → code-reviewer
# - Для авторизации/платежей → + security-auditor`,
        "bash",
      ),
    ]),
  },

  /* =====================================================
     7. Quality Gates и Anti-Mirage
     ===================================================== */
  {
    slug: "quality-gates-i-anti-mirage",
    seoTitle: "Quality Gates и Anti-Mirage — проверка качества AI-кода",
    seoDescription:
      "Quality Gates: матрица проверок, severity-уровни, правило 3 попыток. Anti-Mirage: типы галлюцинаций AI и как их поймать до деплоя.",
    content: root([
      heading(2, "Quality Gates — зачем нужна система"),
      paragraph(
        "AI пишет код быстро, но ошибается. Без системы проверок ошибки накапливаются и обнаруживаются поздно — когда исправление стоит дорого. Quality Gates — набор барьеров, через которые код проходит автоматически.",
      ),
      list([
        "**Gate 1** — после создания плана (для фич M и L)",
        "**Gate 2** — после написания кода (>10 строк)",
        "**Gate 3** — перед деплоем (для фич M и L)",
      ]),
      quote("Проблема на Gate 1 обходится в 10 раз дешевле, чем на Gate 3."),

      hr(),

      heading(2, "Gate 2: Ревью кода (самый важный)"),
      paragraph(
        "Триггер: написан код >10 строк. Всегда включает Anti-Mirage check.",
      ),

      heading(3, "Автоматические проверки через хуки"),
      list([
        "**security-scan.sh** — SQLi, XSS, OS-инъекции при каждом Write/Edit",
        "**protect-secrets.sh** — блокирует запись API-ключей, токенов, паролей в код",
        "**destructive-guard.sh** — блокирует `rm -rf /`, `DROP TABLE`, форс-пуш в main",
        "**prettier / ruff** — автоформатирование JS/TS и Python после каждого файла",
      ]),

      heading(3, "Severity — уровни серьёзности"),
      list([
        "**Critical** — обязательно исправить до продолжения. Ре-верификация после исправления",
        "**Major** — исправить в этой же сессии. Не блокирует, но нужно",
        "**Minor** — исправить если займёт <2 минуты. Иначе → записать в техдолг",
      ]),
      codeBlock(
        `# Примеры по severity

Critical:
  - SQL инъекция в публичном эндпоинте
  - Хардкод пароля или токена в коде
  - Эндпоинт без проверки авторизации

Major:
  - Функция 80 строк (должна быть <50)
  - Дублирование бизнес-логики в двух местах
  - Отсутствие тестов для критичной функции

Minor:
  - Комментарий на английском (нужен русский)
  - Переменная с нечётким именем
  - Неоптимальный запрос (но работает)`,
        "text",
      ),

      heading(3, "Правило трёх попыток"),
      codeBlock(
        `Попытка 1: проверка → findings → исправление
Попытка 2: ре-проверка → findings → исправление
Попытка 3: финальная → если issues есть → эскалация

Эскалация = сообщить пользователю + прекратить цикл.
Нельзя крутиться бесконечно — это сжигает токены впустую.`,
        "text",
      ),

      hr(),

      heading(2, "Anti-Mirage — проверка реальности"),
      paragraph(
        "Claude любит «галлюцинировать» — ссылаться на несуществующие файлы, функции, API, пакеты. Это **самая частая причина ошибок** при AI-разработке. Anti-Mirage — правила и проверки, которые это предотвращают.",
      ),

      heading(3, "Типичные миражи и как их поймать"),
      codeBlock(
        `# Мираж 1: Несуществующий файл
# Claude: "Добавь логику в src/utils/payment-helpers.ts"
# Реальность: файла нет
ls src/utils/  # проверяем что есть

# Мираж 2: Несуществующая функция
# Claude: "Вызови UserService.getByTelegramId()"
# Реальность: метод называется findByTgId()
grep -n "getByTelegramId\|findByTgId" src/services/user.ts

# Мираж 3: Устаревший API библиотеки
# Claude: "requests.get_async(url)"  ← такого метода нет
# Проверка: context7 → актуальная документация requests

# Мираж 4: Фантомный пакет
# Claude: "npm install react-query-v4-compat"
npm info react-query-v4-compat 2>&1 || echo "Пакет не найден"

# Мираж 5: Несуществующее поле БД
# Claude: "WHERE user.role = 'admin'"  ← поля role нет в схеме
grep "role" prisma/schema.prisma`,
        "bash",
      ),

      heading(3, "Чеклист Anti-Mirage"),
      list([
        "**Импорты** — каждый `import/require/from` ссылается на существующий файл",
        "**Функции** — каждая вызываемая функция существует в импортируемом модуле",
        "**Env vars** — каждый `process.env.X` описан в `.env.example`",
        "**Пакеты** — каждый внешний пакет указан в `package.json` / `requirements.txt`",
        "**API endpoints** — URL и метод внешнего API актуальны (проверь через context7)",
      ]),

      heading(3, "Скрипт автоматической проверки импортов"),
      codeBlock(
        `#!/bin/bash
# .claude/hooks/check-imports.sh
# Запускается PostToolUse:Write|Edit для .ts/.tsx файлов

FILEPATH="$1"
[[ "$FILEPATH" != *.ts && "$FILEPATH" != *.tsx ]] && exit 0

echo "Anti-Mirage: проверяю импорты в $FILEPATH..."
DIR=$(dirname "$FILEPATH")
ERRORS=0

# Извлечь и проверить локальные импорты
while IFS= read -r imp; do
  found=0
  for ext in "" ".ts" ".tsx" "/index.ts" "/index.tsx"; do
    [ -f "$DIR/$imp$ext" ] && found=1 && break
  done
  [ $found -eq 0 ] && echo "WARN: Импорт не найден: $imp" && ERRORS=$((ERRORS+1))
done < <(grep -oP "from ['\"]\\K\\.{1,2}/[^'\"]*" "$FILEPATH")

[ $ERRORS -gt 0 ] && exit 1
echo "Anti-Mirage: OK"`,
        "bash",
      ),
      paragraph(
        "Anti-Mirage — единственная проверка, которую **никогда нельзя пропускать**. Она дешёвая (минуты) и ценная (спасает часы отладки).",
      ),
    ]),
  },

  /* =====================================================
     8. Паттерны опытного вайбкодера
     ===================================================== */
  {
    slug: "patterny-opytnogo-vajbkodera",
    seoTitle: "Паттерны опытного вайбкодера — 12 практик Claude Code",
    seoDescription:
      "12 паттернов вайбкодера: TDD-якоря, decisions.md, wave-параллелизм, atomic commits, cost-awareness. Что отличает про от новичка.",
    content: root([
      heading(2, "12 паттернов, которые отличают новичка от про"),
      paragraph(
        "Эти паттерны выработались в реальных проектах. Каждый решает конкретную проблему, с которой сталкивается любой вайбкодер после первых нескольких проектов.",
      ),

      hr(),

      heading(3, "1. Двунаправленная трассировка требований"),
      paragraph("Проверяй связь user-spec ↔ tech-spec в обе стороны:"),
      list([
        "**Forward**: каждое требование из user-spec отражено в tech-spec? Ничего не потерялось?",
        "**Reverse**: каждая задача в tech-spec обоснована требованием? Нет ли лишнего?",
      ]),
      codeBlock(
        `# Промпт для трассировки
claude "Запусти completeness-validator для user-spec.md и tech-spec.md.
Найди:
1. Требования из user-spec, не отражённые в tech-spec
2. Задачи в tech-spec без обоснования из user-spec"`,
        "bash",
      ),

      heading(3, "2. TDD-якоря в спецификациях"),
      paragraph("Опиши тесты уже в tech-spec, не жди фазы реализации:"),
      codeBlock(
        `## Task-007: Регистрация пользователя

### TDD-якорь:
- test_register_creates_user_in_db
- test_register_returns_jwt_token
- test_register_duplicate_email_returns_409
- test_register_invalid_email_returns_400
- test_register_weak_password_returns_400
- test_register_missing_field_returns_400`,
        "markdown",
      ),
      paragraph(
        "Когда Claude видит TDD-якоря — он пишет именно эти тесты, не изобретает своё.",
      ),

      heading(3, "3. Context Files — загрузка по требованию"),
      paragraph(
        "Не грузи весь проект в контекст. Каждая задача содержит список нужных файлов:",
      ),
      codeBlock(
        `## Task-003: Валидация email

### Context Files:
- src/validators/email.ts    # изменить
- src/api/auth.ts            # изменить
- tests/validators.test.ts   # изменить
# НЕ нужны: вся папка services/, модели, конфиги

# Меньше контекст → быстрее модель → дешевле → точнее`,
        "text",
      ),

      heading(3, "4. Decisions.md — журнал решений"),
      paragraph("Записывай ПОЧЕМУ, не только ЧТО:"),
      codeBlock(
        `## [2026-02-15] PostgreSQL вместо MongoDB

**Контекст:** Нужна БД для транзакций и отчётов.

**Решение:** PostgreSQL 16.

**Альтернативы:**
- MongoDB — отпал из-за отсутствия ACID-транзакций
- SQLite — не подходит для продакшн нагрузки

**Последствия:**
- Нужны миграции (Prisma Migrate)
- Строгая schema, зато гарантии целостности данных`,
        "markdown",
      ),

      heading(3, "5. Wave-параллелизм"),
      codeBlock(
        `# Задачи в одной волне = не пересекаются по файлам
Wave 2 (параллельно):
  task-003 → services/user.ts, models/user.ts
  task-004 → utils/jwt.ts, config/auth.ts
  # OK: файлы разные → запускаем параллельно

# Задачи в разных волнах = есть зависимость
Wave 3 (после Wave 2):
  task-005 → импортирует из services/user.ts  (task-003)
  task-006 → использует utils/jwt.ts          (task-004)`,
        "text",
      ),

      heading(3, "6. Правило трёх попыток"),
      paragraph(
        "Жёсткий лимит на любой цикл — не позволяй AI крутиться бесконечно:",
      ),
      codeBlock(
        `Попытка 1: fix → test → fail → углубляемся
Попытка 2: fix → test → fail → диагностика
Попытка 3: fix → test → fail → СТОП

→ Вывести диагностику пользователю
→ Спросить как продолжать
→ Прекратить автоматические попытки`,
        "text",
      ),

      heading(3, "7. Восстановление контекста после Compaction"),
      paragraph(
        "В длинных сессиях контекст сжимается. Hook для восстановления:",
      ),
      codeBlock(
        `#!/bin/bash
# .claude/hooks/reinject-context.sh
# Триггер: Notification:compaction

echo "=== ВОССТАНОВЛЕНИЕ КОНТЕКСТА ==="
echo "--- Текущая задача ---"
cat .claude/current-task.md 2>/dev/null || echo "(нет)"
echo "--- Активные файлы ---"
cat .claude/active-files.txt 2>/dev/null || echo "(нет)"
echo "--- Прогресс (хвост CLAUDE.md) ---"
tail -30 CLAUDE.md`,
        "bash",
      ),

      heading(3, "8. Промпт = конкретика"),
      codeBlock(
        `# Плохо — расплывчато, Claude будет угадывать
"Добавь авторизацию"

# Хорошо — конкретно, Claude знает что делать
"Добавь JWT авторизацию:
- Стек: Next.js 15 + NextAuth.js 5
- Провайдеры: email/password + Telegram
- Token: httpOnly cookie, 7 дней
- Файлы: src/auth.ts (создать)
         src/app/api/auth/[...nextauth]/route.ts (изменить)
- Users коллекция уже есть в Payload CMS"`,
        "text",
      ),

      heading(3, "9. Cost-Awareness — следи за расходами"),
      list([
        "Sonnet для рутины (~5x дешевле Opus)",
        "Opus для архитектуры и ревью критичного кода",
        "Haiku для форматирования и простых правок",
        "Не грузи лишний контекст — каждый файл стоит токены",
        "Смотри на дашборд Anthropic Console раз в неделю",
      ]),
      codeBlock(
        `# Переключение модели по задаче
claude --model claude-sonnet-4-5  # рутинная реализация
claude --model claude-opus-4-5    # архитектура и ревью
claude --model claude-haiku-4-5   # мелкие правки`,
        "bash",
      ),

      heading(3, "10. Atomic Commits — один коммит = одно изменение"),
      list([
        "Сломалась одна фича — откатываешь только её",
        "Легко ревьюить — понятно что зачем изменено",
        "Автогенерация changelog — `git log --oneline` сразу читаем",
      ]),
      codeBlock(
        `# Conventional Commits — обязательный формат
feat: добавить регистрацию через Telegram
fix: исправить 500 при пустом email в /api/auth/register
test: покрыть UserService.create() unit-тестами
refactor: вынести JWT логику в src/utils/jwt.ts
docs: обновить deployment.md после миграции на Docker`,
        "bash",
      ),

      heading(3, '11. Бэклог вместо "потом сделаю"'),
      paragraph(
        '"Потом" никогда не наступает без системы. Все отложенные задачи — в бэклог:',
      ),
      codeBlock(
        `# Добавить в бэклог
claude "/backlog add Оптимизировать запрос в getFeedPage — N+1"
claude "/backlog add Написать тест для edge-case в payment.ts"

# Просмотреть накопленный техдолг
claude "/backlog list"`,
        "bash",
      ),

      heading(3, "12. Глубинное интервью вместо поверхностного брифа"),
      list([
        "Проблема: «Нам нужен дашборд аналитики»",
        "Глубинный вопрос: «Кто смотрит? Что решает, глядя на него? Главный вопрос, на который должен отвечать?»",
        "Результат: понимаешь, что нужен не дашборд, а еженедельный email-отчёт — это в 5 раз проще",
      ]),
      paragraph(
        "Субагент **business-analyst** задаёт десятки вопросов — это дорого по токенам, но на порядок дешевле, чем переделывать проект из-за пропущенных требований.",
      ),

      hr(),

      heading(2, "С чего начать — приоритет по отдаче"),
      list([
        "**Немедленно**: atomic commits (#10) + конкретные промпты (#8)",
        "**После 2–3 проектов**: TDD-якоря (#2) + Anti-Mirage проверки",
        "**В крупных проектах**: wave-параллелизм (#5) + decisions.md (#4)",
        '**После первой "сломанной" сессии**: reinject-context (#7) + правило трёх попыток (#6)',
      ]),
      paragraph(
        "Не пытайся применить все 12 паттернов сразу. Начни с двух — и уже будешь продуктивнее большинства.",
      ),
    ]),
  },
];
